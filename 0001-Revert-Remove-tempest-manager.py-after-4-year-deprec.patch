From 0a29122ae3626228503fb185e089d12426ceee5a Mon Sep 17 00:00:00 2001
From: Martin Kopec <mkopec@redhat.com>
Date: Mon, 15 Mar 2021 12:29:33 +0000
Subject: [PATCH] Revert "Remove tempest/manager.py after 4 year deprecation"

This reverts commit 743d4953f096a6f2f2e62c4b95aa747ce4642fcd.
---
 .../Remove-manager-2e0b0af48f01294a.yaml      |  5 --
 tempest/manager.py                            | 62 +++++++++++++++++++
 tools/generate-tempest-plugins-list.py        |  3 -
 3 files changed, 62 insertions(+), 8 deletions(-)
 delete mode 100644 releasenotes/notes/Remove-manager-2e0b0af48f01294a.yaml
 create mode 100644 tempest/manager.py

diff --git a/releasenotes/notes/Remove-manager-2e0b0af48f01294a.yaml b/releasenotes/notes/Remove-manager-2e0b0af48f01294a.yaml
deleted file mode 100644
index 822df7d00..000000000
--- a/releasenotes/notes/Remove-manager-2e0b0af48f01294a.yaml
+++ /dev/null
@@ -1,5 +0,0 @@
----
-upgrade:
-  - |
-    In this release tempest/manager.py is removed after more than 4 years
-    of deprecation.
diff --git a/tempest/manager.py b/tempest/manager.py
new file mode 100644
index 000000000..b485ef242
--- /dev/null
+++ b/tempest/manager.py
@@ -0,0 +1,62 @@
+# Copyright 2012 OpenStack Foundation
+# All Rights Reserved.
+#
+#    Licensed under the Apache License, Version 2.0 (the "License"); you may
+#    not use this file except in compliance with the License. You may obtain
+#    a copy of the License at
+#
+#         http://www.apache.org/licenses/LICENSE-2.0
+#
+#    Unless required by applicable law or agreed to in writing, software
+#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
+#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
+#    License for the specific language governing permissions and limitations
+#    under the License.
+
+from oslo_log import log as logging
+
+from tempest import clients as tempest_clients
+from tempest import config
+from tempest.lib.services import clients
+
+CONF = config.CONF
+LOG = logging.getLogger(__name__)
+
+
+class Manager(clients.ServiceClients):
+    """Service client manager class for backward compatibility
+
+    The former manager.Manager is not a stable interface in Tempest,
+    nonetheless it is consumed by a number of plugins already. This class
+    exists to provide some grace time for the move to tempest.lib.
+    """
+
+    def __init__(self, credentials, scope='project'):
+        msg = ("tempest.manager.Manager is not a stable interface and as such "
+               "it should not be imported directly. It will be removed as "
+               "soon as the client manager becomes available in tempest.lib.")
+        LOG.warning(msg)
+        dscv = CONF.identity.disable_ssl_certificate_validation
+        _, uri = tempest_clients.get_auth_provider_class(credentials)
+        super(Manager, self).__init__(
+            credentials=credentials, scope=scope,
+            identity_uri=uri,
+            disable_ssl_certificate_validation=dscv,
+            ca_certs=CONF.identity.ca_certificates_file,
+            trace_requests=CONF.debug.trace_requests)
+
+
+def get_auth_provider(credentials, pre_auth=False, scope='project'):
+    """Shim to get_auth_provider in clients.py
+
+    get_auth_provider used to be hosted in this module, but it has been
+    moved to clients.py now as a more permanent location.
+    This module will be removed eventually, and this shim is only
+    maintained for the benefit of plugins already consuming this interface.
+    """
+    msg = ("tempest.manager.get_auth_provider is not a stable interface and "
+           "as such it should not imported directly. It will be removed as "
+           "the client manager becomes available in tempest.lib.")
+    LOG.warning(msg)
+    return tempest_clients.get_auth_provider(credentials=credentials,
+                                             pre_auth=pre_auth, scope=scope)
diff --git a/tools/generate-tempest-plugins-list.py b/tools/generate-tempest-plugins-list.py
index 1b5b369a2..415ad057b 100644
--- a/tools/generate-tempest-plugins-list.py
+++ b/tools/generate-tempest-plugins-list.py
@@ -54,9 +54,6 @@ NON_ACTIVE_LIST = [
     'x/kingbird',  # https://bugs.launchpad.net/kingbird/+bug/1869722
     # vmware-nsx is excluded since https://review.opendev.org/#/c/736952
     'x/vmware-nsx-tempest-plugin',
-    # mogan is unmaintained now, remove from the list when this is merged:
-    # https://review.opendev.org/c/x/mogan/+/767718
-    'x/mogan',
 ]
 
 url = 'https://review.opendev.org/projects/'
-- 
2.20.1

